<!DOCTYPE html>
<html>
<head>
	<!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
	<link rel="stylesheet" href="css/jquery.mobile-1.4.1.min.css" />
	<script src="js/jquery-1.11.0.min.js"></script>
	<script src="js/jquery.mobile-1.4.1.min.js"></script>
	<script type="text/javascript" src="cordova.js"></script>
	
	<link rel="stylesheet" href="css/themes/ccn20.min.css" />
	<link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
	
	<link rel="stylesheet" href="css/leaflet.css" />
	<link rel="stylesheet" href="css/leaflet.usermarker.css" />
	<link rel="stylesheet" href="css/eserciziVicini.css" />
	<script src="js/leaflet.js"></script>
	<script src="js/leaflet.usermarker.js"></script>
	<script src="js/function_checkConnection.js"></script>
	
	<title>Ricerca Brand</title>
	
	<style>
	#quadrati{
    position:absolute;
	z-index: 1000 !important;
    top: 0;
	right: -20%;
    width: 30%;
    display: block;
	}
	#imgQuadrati{
    width: 30%;
	margin: auto;
	}
	
	.ui-listview li { 
    margin: 2px;
	}

	.ui-listview {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
	}
	</style>
	
</head>
<body>

<!-- Start of page: #eserciziViciniMappa -->
<div data-role="page" id="eserciziViciniMappa">

<div id="quadrati"><img src="img/quadrati.png" id="imgQuadrati"></div>

	<div data-role="header">
		<h1><img src="img/shopincomo_orizzontale.png" style="height:1.2em"></h1>
		<a href="#" data-rel="back" id="indietro" class="jqm-navmenu-link ui-btn ui-corner-all ui-nodisc-icon ui-alt-icon ui-btn-left" data-transition="slide" data-direction="reverse" style="vertical-align: middle; margin: 0.5em; ">indietro</a>
	</div><!-- /header -->

	<div role="main" id="map" class="ui-content" >
		
	<script type="text/javascript" charset="utf-8">
	
	$( document ).on( "pageshow", "#eserciziViciniMappa", function() {
	
	var height = $('[data-role="content"]').height(getRealContentHeight());
	
	var actualHeight = height.context.activeElement.clientHeight;
	
    $('#map').css('height', actualHeight);
	
	var map;
	var userLatitude;
	var userLongitude;
	var userAccuracy;
	var eserciziSort;
	
	navigator.geolocation.getCurrentPosition(onSuccess, onError);
	
	function onSuccess(position) {
	
	userLatitude = position.coords.latitude;
	userLongitude = position.coords.longitude;
	alert(userLatitude);
	alert(userLongitude);
	userAccuracy = position.coords.accuracy;
	$('a.lista').attr('userLatitude', userLatitude);
	$('a.lista').attr('userLongitude', userLongitude);
	}
	
	function onError(error) {
        //alert('code: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
	}
	
	//CARICA JSON CATEGORIE
	var path = window.localStorage.getItem("pathSD");
	var jsonPositionDir = path + "/position.js";
	alert("ciao");
	alert(path);
	alert(jsonPositionDir);
	$.getJSON(jsonPositionDir, function( jsonPosition ) {
		
	
	var eserciziVicini = [];
	
		//NEAREST NODE
		$.each(jsonPosition, function(index, info) {

		var currentDistance;
		var currentEsercizio;

		currentDistance = getDistanceFromLatLonInKm(userLatitude, userLongitude, info.latEsercizio, info.lonEsercizio);
		currentEsercizio = info.idEsercizio;
			if(currentDistance < 500) {
			
			var time = Math.round(parseInt(currentDistance)/(1.4)/60);
			
			eserciziVicini.push({
			idEsercizio: info.idEsercizio,
			nomeEsercizio: info.nomeEsercizio,
			latEsercizio: info.latEsercizio,
			lonEsercizio: info.lonEsercizio,
			idCategoria: info.idCategoria,
			distance: currentDistance,
			time: time
			});
			}
		});
		
		eserciziSort = eserciziVicini.sort(function(a,b) { return parseInt(a.distance) - parseInt(b.distance) } );
	
	
	//INIZIALIZZA MAPPA
	map = new L.Map('map');
	
	
	var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
	L.tileLayer(osmUrl, {minZoom: 13, maxZoom: 18}).addTo(map);
	
	/*
	L.tileLayer('map/{z}/{x}/{y}.jpg', {
		maxZoom: 18
	}).addTo(map);
	*/
	
	var markerUtente;
	var group;
	
	//SET ICONA ESERCIZIO
	var markerIcon = L.icon({
		iconUrl: 'img/marker-icon.png',
		iconSize:     [25, 41], // size of the icon
		popupAnchor:  [0, -20] // point from which the popup should open relative to the iconAnchor
	});
		
	var markerEsercizio;
	
	$.each(eserciziSort, function(index, info) {

	markerEsercizio = L.marker([info.latEsercizio, info.lonEsercizio], {icon: markerIcon}).addTo(map).bindPopup(info.nomeEsercizio);
	
	});
	
	//SET ICONA UTENTE
	if (!markerUtente) {
	markerUtente = L.userMarker([userLatitude, userLongitude],{pulsing:true}).bindPopup("Sei qui.").addTo(map);
	markerUtente.setAccuracy(userAccuracy);
	
	//ADATTA LA MAPPA
	group = new L.featureGroup([markerEsercizio, markerUtente]);
	}
	
	//UPDATE POSIZIONE UTENTE
	markerUtente.setLatLng([userLatitude, userLongitude],{pulsing:true}).update();
	
	//RAGGRUPPA MARKER
	group = new L.featureGroup([markerEsercizio, markerUtente]);
	map.fitBounds(group.getBounds().pad(0.25));
	
	
	}); // FINE GET JSON POSITION
	
	}); // FINE PAGESHOW
	
	function getRealContentHeight() {
    var header = $.mobile.activePage.find("div[data-role='header']:visible");
    var footer = $.mobile.activePage.find("div[data-role='footer']:visible");
    var content = $.mobile.activePage.find("div[data-role='content']:visible:visible");
    var viewport_height = $(window).height();

    var content_height = viewport_height - header.outerHeight() - footer.outerHeight();
    if((content.outerHeight() - header.outerHeight() - footer.outerHeight()) <= viewport_height) {
        content_height -= (content.outerHeight() - content.height());
    } 
    return content_height;
	}
	
	function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
  
		var R = 6371; // Radius of the earth in km
  
		var dLat = deg2rad(lat2-lat1);  // deg2rad below
		var dLon = deg2rad(lon2-lon1); 
  
		var a = 
		Math.sin(dLat/2) * Math.sin(dLat/2) +
		Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
		Math.sin(dLon/2) * Math.sin(dLon/2)
		; 
  
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var d = R * c * 1000; // Distance in km
		return Math.round(d);
	}

	function deg2rad(deg) {
	
	return deg * (Math.PI/180)
	}
	
	$(document).on("click", 'a.lista', function(){
		userLatitude = $(this).attr('userLatitude');
		userLongitude = $(this).attr('userLongitude');
	});
	
	
	
	</script>
	
	</div><!-- /content -->

	<!-- FOOTER -->
	<div data-role="footer" data-theme="a" data-position="fixed" data-tap-toggle="false">
	<!-- NAVBAR -->
		<div data-role="navbar">
		<ul>
			<li><a href="#" data-icon="gear" class="ui-btn-active ui-state-persist">Mappa</a></li>
			<li class="elencoNegozi"><a href="#eserciziViciniLista" class="lista" data-transition="slide" data-icon="gear">Lista</a></li>
		</ul>
		</div>
	<!-- /NAVBAR -->
	</div>
	<!-- /FOOTER -->
	
</div><!-- /page eserciziViciniMappa -->

<!-- Start of page: #eserciziViciniLista -->
<div data-role="page" id="eserciziViciniLista">

	<div id="quadrati"></div>

	<div data-role="header">
		<h1><img src="img/shopincomo_orizzontale.png" style="height:2.5em"></h1>
		<a href="#" data-rel="back" id="indietro" class="jqm-navmenu-link ui-btn ui-corner-all ui-nodisc-icon ui-alt-icon ui-btn-left" data-transition="slide" data-direction="reverse">indietro</a>
	</div><!-- /header -->

	<div role="main" class="ui-content" >
	
	<script>
	
	$( document ).on( "pageshow", "#eserciziViciniLista", function() {
	
	var latUser = userLatitude;
	var lonUser = userLongitude;		
	
	var path = window.localStorage.getItem("pathSD");
	var jsonPositionDir = path + "/position.js";
	$.getJSON(jsonPositionDir, function( jsonPosition ) {
	
	var eserciziVicini = [];
	
		//NEAREST NODE
		$.each(jsonPosition, function(index, info) {
		
		var currentDistance;
		var currentEsercizio;
		
		currentDistance = getDistanceFromLatLonInKm(latUser, lonUser, info.latEsercizio, info.lonEsercizio);
		currentEsercizio = info.idEsercizio;
		
			if(currentDistance < 500) {
			
			var time = Math.round(parseInt(currentDistance)/(1.4)/60);
			
			eserciziVicini.push({
			idEsercizio: info.idEsercizio,
			nomeEsercizio: info.nomeEsercizio,
			idCategoria: info.idCategoria,
			distance: currentDistance,
			time: time
			});
			}
		});
		
		var eserciziSort = eserciziVicini.sort(function(a,b) { return parseInt(a.distance) - parseInt(b.distance) } );
		
		
		
		$("ul#listaEsercizi").html("");
		
		$.each(eserciziSort, function(index, info) {
		$("ul#listaEsercizi").append($("<li></li>",{"html":'<a href="#" class="esercizio" idEsercizio='" + info.idEsercizio + "' data-transition="slide" ><img src="../_assets/img/album-p.jpg"><h2>'+info.nomeEsercizio+'</h2><p>'+info.time+'</p></a>' }));
		});
		
		$("ul#listaEsercizi").listview().listview('refresh');
	
	}); // FINE GET JSON POSITION
	
	});
	
	function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
  
		var R = 6371; // Radius of the earth in km
  
		var dLat = deg2rad(lat2-lat1);  // deg2rad below
		var dLon = deg2rad(lon2-lon1); 
  
		var a = 
		Math.sin(dLat/2) * Math.sin(dLat/2) +
		Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
		Math.sin(dLon/2) * Math.sin(dLon/2)
		; 
  
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var d = R * c * 1000; // Distance in km
		return Math.round(d);
	}

	function deg2rad(deg) {
	
	return deg * (Math.PI/180)
	}
	
	</script>
		
	<ul data-role="listview" id="listaEsercizi" data-inset="true">
	</ul>
	
	</div><!-- /content -->

	<!-- FOOTER -->
	<div data-role="footer" data-theme="a" data-position="fixed">
	<!-- NAVBAR -->
		<div data-role="navbar">
			<ul>
			<li><a href="#eserciziViciniMappa" data-transition="slide" data-direction="reverse" data-icon="gear" >Mappa</a></li>
			<li><a href="#" data-icon="gear" class="ui-btn-active ui-state-persist">Lista</a></li>
		</ul>
		</div>
	<!-- /NAVBAR -->
	</div>
	<!-- /FOOTER -->
</div><!-- /page eserciziViciniLista -->

</body>
</html>