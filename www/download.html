<!DOCTYPE html>
<html>
<head>
	<title>Page Title</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="css/jquery.mobile-1.4.1.min.css" />
	<script src="js/jquery-1.11.0.min.js"></script>
	<script src="js/jquery.mobile-1.4.1.min.js"></script>
	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="js/function_checkConnection.js"></script>
	<!-- cordova facebook plugin -->
	<script src="cdv-plugin-fb-connect.js"></script>
	<!-- facebook js sdk -->
	<script src="facebook-js-sdk.js"></script>
</head>
<body>

<!-- Start of page: #download -->
<div data-role="page" id="download">

	<div id="quadrati"></div>

	<div data-role="header">
		<h1>Download</h1>
		<a href="#" data-rel="back" id="indietro" class="jqm-navmenu-link ui-btn ui-corner-all ui-nodisc-icon ui-alt-icon ui-btn-left" data-transition="slide" data-direction="reverse">indietro</a>
	</div><!-- /header -->

	<div role="main" class="ui-content" >
	
	<script>
	$( "#download" ).on( "pagebeforeshow", function() {	
	
	});
	
	$(document).on("click", 'button.download', function(){
	
	//idLingua = $(this).attr('id');
	//lingua = $(this).attr('nomeLingua');
	codLingua = "it"; //$(this).attr('codiceLingua');
	
	//window.localStorage.setItem("lingua", lingua);
	//window.localStorage.setItem("idLingua", idLingua);
	window.localStorage.setItem("codLingua", codLingua);
	
	var urlCategorie = encodeURI("http://www.wificomo.com/ccn20/JSONcategorie.php?language="+codLingua+"");	
	var fileNameCategorie = "categorie.js";
		
		var fileTransfer = new FileTransfer();
			
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			
			fileSystem.root.getDirectory("ccn", {create: true, exclusive: false}, function(dirEntry) {
			
				dirEntry.getFile(fileNameCategorie, {create: true, exclusive: false}, function(fileEntry) {
										
					var localPath = fileEntry.fullPath;

					if (device.platform === "Android" && localPath.indexOf("file://") === 0) {
						localPath = localPath.substring(7);
					}
					
					fileTransfer.download(
						urlCategorie,
						localPath,
						
						function(entry) {
						
							alert("download complete: " + entry.fullPath);
							
							//MEMORIZZA PATH
								var directory = dirEntry.fullPath;
								var indexPath = directory.lastIndexOf("/");
								var pathSD = directory.substr(7, indexPath-7);
								pathSD = pathSD+"/ccn";
								window.localStorage.setItem('pathSD', pathSD);
								
								getSottocategorie();
						},
						function(error) {
							console.log("download error source " + error.source);
							console.log("download error target " + error.target);
							console.log("download error code " + error.code);
						},
						false,
						{
							headers: {
								"Authorization": "Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="
							}
						}
				
					); // end of fileTransfer.download
				}); // end of dirEntry.getFile
			
			}); // fileSystem.root.getDirectory
			
		}); // end of window.requestFileSystem
		
	
		
	function getSottocategorie()
	{
		var codlingua = window.localStorage.getItem('codLingua');
		var path = window.localStorage.getItem('pathSD');
		var pathCategorie = path+"/categorie.js";
		
		$.getJSON(pathCategorie, function( data ) {
		
			$.each(data, function(index, info) {
		
			var urlSottocategorie = encodeURI("http://www.wificomo.com/ccn20/JSONsottocategorieNegozi.php?idCategoria="+info.idCategoria+"&language="+codLingua+"");	
			var fileNameSottocategorie = info.jsonName+".js";
			var directory = "ccn";
			
			downloadJSON(directory, fileNameSottocategorie, urlSottocategorie);
			});
		});
		
	} //FUNCTION getSottocategorie()
	
	//JSON RICERCA PER NOME
	var urlnomeEsercizi = encodeURI("http://www.wificomo.com/ccn20/JSONnomeEsercizi.php");	
	var fileNamenomeEsercizi = "nomeEsercizi.js";
	var directory = "ccn";
	
	downloadJSON(directory, fileNamenomeEsercizi, urlnomeEsercizi);
	
	//JSON BRAND ESERCIZI
	var urlbrandEsercizi = encodeURI("http://www.wificomo.com/ccn20/JSONbrandEsercizi.php");
	var fileNamebrandEsercizi = "brandEsercizi.js";
	var directory = "ccn";
	
	downloadJSON(directory, fileNamebrandEsercizi, urlbrandEsercizi);
	
	//JSON RICERCA PER BRAND
	var urlbrand = encodeURI("http://www.wificomo.com/ccn20/JSONbrand.php");
	var fileNamebrand = "brand.js";
	var directory = "ccn";
	
	downloadJSON(directory, fileNamebrand, urlbrand);
	
	//JSON POSITION
	var urlposition = encodeURI("http://www.wificomo.com/ccn20/JSONposition.php");
	var filePosition = "position.js";
	var directory = "ccn";
	
	downloadJSON(directory, filePosition, urlposition);
	
	//JSON DISTANCE
	var urldistance = encodeURI("http://www.wificomo.com/ccn20/JSONdistance.php");
	var fileDistance = "distance.js";
	var directory = "ccn";
	
	downloadJSON(directory, fileDistance, urldistance);
	
	});

	
	
	//DOWNLOAD JSON FUNCTION
	function downloadJSON(directory, fileName, fileURL) {
		
		var fileTransfer = new FileTransfer();
		
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			
			fileSystem.root.getDirectory(directory, {create: true, exclusive: false}, function(dirEntry) {
			
				dirEntry.getFile(fileName, {create: true, exclusive: false}, function(fileEntry) {
										
					var localPath = fileEntry.fullPath;

					if (device.platform === "Android" && localPath.indexOf("file://") === 0) {
							localPath = localPath.substring(7);
					}
					
					fileTransfer.onprogress = function(progressEvent) {
						if (progressEvent.lengthComputable) {
						loadingStatus.setPercentage(progressEvent.loaded / progressEvent.total);
						} else {
						loadingStatus.increment();
						}
					};
					
					fileTransfer.download(
						fileURL,
						localPath,
						function(entry) {
						
							/*
							conteggioEsercizi = parseInt(conteggioEsercizi)+1;
															
								if(conteggioEsercizi == totaleEsercizi) {
								alert("scaricati "+conteggioEsercizi+" esercizi");
								sessionStorage.setItem("downloadEsercizi", "ok");
								}
							*/
						},
						function(error) {
							console.log("download error source " + error.source);
							console.log("download error target " + error.target);
						},
						false,
						{
							headers: {
								"Authorization": "Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="
							}
						}
				
					); // end of fileTransfer.download
				}); // end of dirEntry.getFile
			
			}); // fileSystem.root.getDirectory
			
		}); // end of window.requestFileSystem
		
	} //FUNCTION downloadJSON
	
	</script>
		
	<button class="download">download</button>
	
	</div><!-- /content -->

	<!-- FOOTER -->
	<div data-role="footer" data-theme="a" data-position="fixed">
	</div>
	<!-- /FOOTER -->
</div><!-- /page eserciziViciniLista -->

</body>
</html>