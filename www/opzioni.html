<!DOCTYPE html>
<html>
<head>
	<title>Page Title</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="css/jquery.mobile-1.4.1.min.css" />
	
	<script src="js/jquery-1.11.0.min.js"></script>
	<script src="js/jquery.mobile-1.4.1.min.js"></script>
	<script type="text/javascript" src="cordova.js"></script>
	<script type="text/javascript" src="js/function_checkConnection.js"></script>
	<!-- cordova facebook plugin -->
	<script src="cdv-plugin-fb-connect.js"></script>
	<!-- facebook js sdk -->
	<script src="facebook-js-sdk.js"></script>
</head>
<body>

<!-- PAGE #opzioni -->
		<div data-role="page" id="opzioni">

		<!-- /HEADER -->
		<div data-role="header">
		<h1>Opzioni</h1>
		<a href="#" data-rel="back" id="indietro" class="jqm-navmenu-link ui-btn ui-corner-all ui-nodisc-icon ui-alt-icon ui-btn-left" data-transition="slide" data-direction="reverse">indietro</a>
		</div>
		<!-- /HEADER -->
	
		<!-- CONTENT -->
		<div role="main" class="ui-content" >
		
		<script>
		
		document.addEventListener("backbutton", function(e){
    
		if($.mobile.activePage.is('#index')){
        e.preventDefault();
        return false;
		}
		else {
        navigator.app.backHistory()
		}
		}, false);
		
		</script>
		
		<ul data-role="listview" data-inset="true">
			<li><a href="#socialNetworks" data-transition="slide"><h2>Social Networks</h2><p>Collega/scollega account</p></a></li>
			<li><a href="#lingua" data-transition="slide"><h2>Lingua</h2><p>Cambia lingua</p></a></li>
			<li><a href="#database" data-transition="slide"><h2>Database</h2><p>Aggiorna il database degli esercizi</p></a></li>
		</ul>
		
		</div>
		<!-- /CONTENT -->

		<!-- FOOTER -->
		<div data-role="footer" data-theme="a" data-position="fixed"><h4>Page Footer</h4></div>
		<!-- /FOOTER -->
		
		</div>
<!-- /PAGE #opzioni -->

<!-- PAGE #socialNetworks -->
		<div data-role="page" id="socialNetworks">

		<!-- /HEADER -->
		<div data-role="header"><h1>Social Networks</h1></div>
		<!-- /HEADER -->
	
		<!-- CONTENT -->
		<div role="main" class="ui-content" >
		
		<ul data-role="listview" data-inset="true">
			<li><a href="#collegaFacebook" data-transition="slide"><img src="img/facebookList.png" alt="Facebook" class="ui-li-icon ui-corner-none">Facebook</a></li>
			<li><a href="#collegaFoursquare" data-transition="slide"><img src="img/foursquareList.png" alt="Foursquare" class="ui-li-icon ui-corner-none">Foursquare</a></li>
			<li><a href="#collegaTwitter" data-transition="slide"><img src="img/twitterList.png" alt="Twitter" class="ui-li-icon ui-corner-none">Twitter</a></li>
		</ul>
	
		</div>
		<!-- /CONTENT -->

		<!-- FOOTER -->
		<div data-role="footer" data-theme="a" data-position="fixed"><h4>Page Footer</h4></div>
		<!-- /FOOTER -->
		
		</div>
<!-- /PAGE #socialNetworks -->

<!-- PAGE #collegaFacebook -->
		<div data-role="page" id="collegaFacebook">

		<!-- /HEADER -->
		<div data-role="header"><h1>Facebook</h1></div>
		<!-- /HEADER -->
	
		<!-- CONTENT -->
		<div role="main" class="ui-content" >
		
		<div id="fb-root"></div>
		<script>
  
		$( "#collegaFacebook" ).on( "pageshow", function() {	
	
			//FACEBOOK
			FB.init({ appId: "1448410138727682", nativeInterface: CDV.FB, useCachedDialogs: false });
			//GET LOGIN STATUS
			FB.getLoginStatus(function(response) {
				//CONNESSO
				if (response.status === 'connected') {
				$("p.facebook").html('<button class="facebookLogout ui-btn ui-shadow">Facebook: logout</button>');
				}
				//APP NON AUTORIZZATA
				else if (response.status === 'not_authorized') {
				alert("not authorized")
				$("p.facebook").html('<button class="facebookLogin ui-btn ui-shadow">Facebook: Collega Account</button>');
				} 
				//NON CONNESSO
				else {
				$("p.facebook").html('<button class="facebookLogin ui-btn ui-shadow">Facebook: Collega Account</button>');
				}
			}, true);
		}); // ON "pageshow"
		
		//ON "click" button.facebookLogin
		$(document).on("click", 'button.facebookLogin', function(){
			FB.login(function(response) {      
				if (response.authResponse) {
				$("p.facebook").html('<button class="facebookLogout ui-btn ui-shadow">Facebook: logout</button>');
				}
				else {
				alert('not logged in');
				}
			},
			{ scope: "email" }
			);
		}); //ON "click" button.facebookLogin
	
		//ON "click" button.facebookLogout
		$(document).on("click", 'button.facebookLogout', function(){
			FB.logout(function(response) {
			$("p.facebook").html('<button class="facebookLogin ui-btn ui-shadow">Facebook: Collega Account</button>');
			});
		}); //ON "click" button.facebookLogout
		
		</script>
		
		<p class="facebook"></p>
		
		</div>
		<!-- /CONTENT -->

		<!-- FOOTER -->
		<div data-role="footer" data-theme="a" data-position="fixed"><h4>Page Footer</h4></div>
		<!-- /FOOTER -->
		
		</div>
<!-- /PAGE #collegaFacebook -->

<!-- PAGE #collegaFoursquare -->
		<div data-role="page" id="collegaFoursquare">

		<!-- /HEADER -->
		<div data-role="header"><h1>Foursquare</h1></div>
		<!-- /HEADER -->
	
		<!-- CONTENT -->
		<div role="main" class="ui-content" >
		
		<script>
		
		$( "#collegaFoursquare" ).on( "pageshow", function() {
		
			//FOURSQUARE
			var tokenFoursquare = window.localStorage.getItem("tokenFoursquare");
	
			if(tokenFoursquare == null) {
			$("p.foursquare").html('<button class="foursquareLogin ui-btn ui-shadow">Foursquare: Collega Account</button>');
			}
			else {
			$("p.foursquare").html('<button class="foursquareLogout ui-btn ui-shadow">Foursquare: logout</button>');
			}
		});
		
		//ON "click" button.foursquareLogin
		$(document).on("click", 'button.foursquareLogin', function(){
			var ref = window.open('https://foursquare.com/oauth2/authenticate?client_id=4P4XY5XMV2EEGL4THQFXJFMJBTJN4WBNX1VIQGAUWDPHYZZF&response_type=token&redirect_uri=http://www.wificomo.com/ccn20/closeFoursquare.html', '_blank', 'location=no');
			ref.addEventListener('loadstart', function(event) {
			closeFoursquare(event.url,ref);
			}); 
	
			function closeFoursquare(loc,ref) {
   
				if (loc.indexOf("www.wificomo.com/ccn20/closeFoursquare.html#") > -1){
				var tokenFoursquare = loc.substring(loc.indexOf("=")+1);
				window.localStorage.setItem("tokenFoursquare", tokenFoursquare);
				$("p.foursquare").html('<button class="foursquareLogout ui-btn ui-shadow">Foursquare: logout</button>');
				ref.close();
				}
			}
		}); //ON "click" button.foursquareLogin
	
		//ON "click" button.foursquareLogout
		$(document).on("click", 'button.foursquareLogout', function(){
			localStorage.removeItem("tokenFoursquare");
			$("p.foursquare").html('<button class="foursquareLogin ui-btn ui-shadow">Foursquare: Collega Account</button>');
		}); ////ON "click" button.foursquareLogout
	
		</script>

		<p class="foursquare"></p>

		</div>
		<!-- /CONTENT -->

		<!-- FOOTER -->
		<div data-role="footer" data-theme="a" data-position="fixed"><h4>Page Footer</h4></div>
		<!-- /FOOTER -->
		
		</div>
<!-- /PAGE #collegaFoursquare -->

<!-- PAGE #collegaTwitter -->
		<div data-role="page" id="collegaTwitter">

		<!-- /HEADER -->
		<div data-role="header"><h1>Twitter</h1></div>
		<!-- /HEADER -->
	
		<!-- CONTENT -->
		<div role="main" class="ui-content" >
		
		<script>
		$( "#collegaFoursquare" ).on( "pageshow", function() {
		
			//TWITTER
			var twitterToken = window.localStorage.getItem("twitterToken");
	
			if(twitterToken == null) {
			$("p.twitter").html('<button class="twitterLogin ui-btn ui-shadow">Twitter: Collega Account</button>');
			}
			else {
			$("p.twitter").html('<button class="twitterLogout ui-btn ui-shadow">Twitter: logout</button>');
			}	
			
		}); //ON "pagebeforeshow"
		
		//ON "click" button.twitterLogin
		$(document).on("click", 'button.twitterLogin', function(){
	
			var ref = window.open('http://www.wificomo.com/twitter/twitterConnect.php', '_blank', 'location=no');
			ref.addEventListener('loadstart', function(event) {
			closeTwitter(event.url,ref);
			});  
	
			function closeTwitter(loc,ref) {
   
				if (loc.indexOf("www.wificomo.com/twitter/twitterTokens.php?") > -1){
				var twitterToken = loc.substring(loc.indexOf("oauth_token=")+12, loc.indexOf("&"));
				var twitterVerifier = loc.substring(loc.indexOf("oauth_verifier=")+15, loc.indexOf("&t"));
				var twitterName = loc.substring(loc.indexOf("twitterName=")+12);
				twitterName = decodeURIComponent(twitterName);
		
				window.localStorage.setItem("twitterToken", twitterToken);
				window.localStorage.setItem("twitterVerifier", twitterVerifier);
				window.localStorage.setItem("twitterName", twitterName);
		
				$("p.twitter").html('<button class="twitterLogout ui-btn ui-shadow">Twitter: logout</button>');
		
				ref.close();
				}
			}
	
		}); //ON "click" button.twitterLogin
	
		//ON "click" button.twitterLogout
		$(document).on("click", 'button.twitterLogout', function(){
			localStorage.removeItem("twitterToken");
			localStorage.removeItem("twitterVerifier");
			localStorage.removeItem("twitterName");
			$("p.twitter").html('<button class="twitterLogin ui-btn ui-shadow">Twitter: Collega Account</button>');
		}); //ON "click" button.twitterLogout
	
		</script>
	
		<p class="twitter"></p>
	
		</div>
		<!-- /CONTENT -->

		<!-- FOOTER -->
		<div data-role="footer" data-theme="a" data-position="fixed"><h4>Page Footer</h4></div>
		<!-- /FOOTER -->
		
		</div>
<!-- /PAGE #collegaTwitter -->

<!-- PAGE #lingua -->
		<div data-role="page" id="lingua">

		<!-- /HEADER -->
		<div data-role="header"><h1>Lingua</h1></div>
		<!-- /HEADER -->
	
		<!-- CONTENT -->
		<div role="main" class="ui-content" >
	
		<script>
		$( "#lingua" ).on( "pagebeforeshow", function() {	
		
		//LISTA LINGUE
		$("ul#listaLingue").html("");
		
		$.getJSON("js/lingue.js", function( data ) {
		
			$.each(data, function(index, info) {
			$("ul#listaLingue").append($("<li></li>",{"html":"<a href='#downloadLingua' class='lingua' id='" + info.idLingua + "' codiceLingua='"+info.codiceLingua+"' nomeLingua='"+index+"' data-transition='slide' ><img src='img/lingue/"+info.codiceLingua+".png' alt='Facebook' class='ui-li-icon ui-corner-none'>" + info.nomeLingua + "</a>" }));
			});
	
			$("ul#listaLingue").listview("refresh");
		});
		
	}); //ON "pagebeforeshow"
	
	//ON "click"
	$(document).on("click", 'a.lingua', function(){
	
	idLingua = $(this).attr('id');
	lingua = $(this).attr('nomeLingua');
	codLingua = $(this).attr('codiceLingua');
	
	window.localStorage.setItem("lingua", lingua);
	window.localStorage.setItem("idLingua", idLingua);
	window.localStorage.setItem("codLingua", codLingua);
	
	}); //ON "click"
	
		</script>
		
		<ul data-role="listview" id="listaLingue" data-inset="true">
		</ul>
	
		</div>
		<!-- /CONTENT -->

		<!-- FOOTER -->
		<div data-role="footer" data-theme="a" data-position="fixed"><h4>Page Footer</h4></div>
		<!-- /FOOTER -->
		
		</div>
<!-- /PAGE #lingua -->

<!-- PAGE #downloadLingua -->
		<div data-role="page" id="downloadLingua">

		<!-- /HEADER -->
		<div data-role="header"><h1>DownloadLingua</h1></div>
		<!-- /HEADER -->
	
		<!-- CONTENT -->
		<div role="main" class="ui-content" >
	
		<script>
		$( "#downloadLingua" ).on( "pageshow", function() {	
	
	sessionStorage.setItem("vetrineOK", 0);
	
	var urlCategorie = encodeURI("http://www.wificomo.com/ccn20/JSONcategorie.php?language="+codLingua+"");	
	var fileNameCategorie = "categorie.js";
		
		var fileTransfer = new FileTransfer();
			
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			
			fileSystem.root.getDirectory("ccn", {create: true, exclusive: false}, function(dirEntry) {
			
				dirEntry.getFile(fileNameCategorie, {create: true, exclusive: false}, function(fileEntry) {
										
					var localPath = fileEntry.fullPath;

					if (device.platform === "Android" && localPath.indexOf("file://") === 0) {
						localPath = localPath.substring(7);
					}
					
					fileTransfer.download(
						urlCategorie,
						localPath,
						
						function(entry) {
						
								//MEMORIZZA PATH
								var directory = dirEntry.fullPath;
								var indexPath = directory.lastIndexOf("/");
								var pathSD = directory.substr(7, indexPath-7);
								pathSD = pathSD+"/ccn";
								window.localStorage.setItem('pathSD', pathSD);
								
								$("li.categorie").html("download categorie <img src='img/downloadok.png'>");
								$("li.categorie").css("color","green");
								
								getSottocategorie();
						},
						function(error) {
							console.log("download error source " + error.source);
							console.log("download error target " + error.target);
							console.log("download error code " + error.code);
						},
						false,
						{
							headers: {
								"Authorization": "Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="
							}
						}
				
					); // end of fileTransfer.download
				}); // end of dirEntry.getFile
			
			}); // fileSystem.root.getDirectory
			
		}); // end of window.requestFileSystem
		
	//FUNCTION getSottocategorie()
	function getSottocategorie()
	{
	
		var codlingua = window.localStorage.getItem('codLingua');
		var path = window.localStorage.getItem('pathSD');
		var pathCategorie = path+"/categorie.js";
		
		$.getJSON(pathCategorie, function( data ) {
		
			var numElementi = data.length;
			
			window.sessionStorage.setItem("numElementi", numElementi);
		
			$.each(data, function(index, info) {
			
			var urlSottocategorie = encodeURI("http://www.wificomo.com/ccn20/JSONsottocategorieNegozi.php?idCategoria="+info.idCategoria+"&language="+codLingua+"");	
			var fileNameSottocategorie = info.jsonName+".js";
			var directory = "ccn";
			
			downloadJSONmulti(directory, fileNameSottocategorie, urlSottocategorie);
			});
		});
		
	} //FUNCTION getSottocategorie()
	
	//JSON RICERCA PER NOME
	
	var urlnomeEsercizi = encodeURI("http://www.wificomo.com/ccn20/JSONnomeEsercizi.php");	
	var fileNamenomeEsercizi = "nomeEsercizi.js";
	var directory = "ccn";
	var pClass = "nome";
	
	downloadJSON(directory, fileNamenomeEsercizi, urlnomeEsercizi, pClass);
	
	//JSON BRAND ESERCIZI
	
	var urlbrandEsercizi = encodeURI("http://www.wificomo.com/ccn20/JSONbrandEsercizi.php");
	var fileNamebrandEsercizi = "brandEsercizi.js";
	var directory = "ccn";
	var pClass = "brandEsercizi";
	
	downloadJSON(directory, fileNamebrandEsercizi, urlbrandEsercizi, pClass);
	
	//JSON RICERCA PER BRAND
	
	var urlbrand = encodeURI("http://www.wificomo.com/ccn20/JSONbrand.php");
	var fileNamebrand = "brand.js";
	var directory = "ccn";
	var pClass = "brand";
	
	downloadJSON(directory, fileNamebrand, urlbrand, pClass);
	
	//JSON POSITION
	
	var urlposition = encodeURI("http://www.wificomo.com/ccn20/JSONposition.php");
	var filePosition = "position.js";
	var directory = "ccn";
	var pClass = "position";
	
	downloadJSON(directory, filePosition, urlposition, pClass);
	
	//JSON DISTANCE
	
	var urldistance = encodeURI("http://www.wificomo.com/ccn20/JSONdistance.php");
	var fileDistance = "distance.js";
	var directory = "ccn";
	var pClass = "distance";
	
	downloadJSON(directory, fileDistance, urldistance, pClass);
		
	// TRADUZIONI------------------------------------------------------------------------------
	
	// T.Indietro
	window.localStorage.setItem("indietro", lingue[lingua].indietro);
	// T.Categories
	window.localStorage.setItem("Categorie", lingue[lingua].Categorie);
	// T.filtra
	window.localStorage.setItem("filtra", lingue[lingua].filtra);
	// T.ordina
	window.localStorage.setItem("ordina", lingue[lingua].ordina);
	// T.salta
	window.localStorage.setItem("salta", lingue[lingua].salta);
	
	// /TRADUZIONI----------------------------------------------------------------------------
	
	}); // ON "pageshow"
	
	//DOWNLOAD JSON FUNCTION
	function downloadJSON(directory, fileName, fileURL, pClass) {
		
		var fileTransfer = new FileTransfer();
		
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			
			fileSystem.root.getDirectory(directory, {create: true, exclusive: false}, function(dirEntry) {
			
				dirEntry.getFile(fileName, {create: true, exclusive: false}, function(fileEntry) {
										
					var localPath = fileEntry.fullPath;

					if (device.platform === "Android" && localPath.indexOf("file://") === 0) {
							localPath = localPath.substring(7);
					}
					
					fileTransfer.download(
						fileURL,
						localPath,
						function(entry) {
						
						$("li."+pClass+"").html("download "+pClass+" <img src='img/downloadok.png'>");
						$("li."+pClass+"").css("color","green");
						
							/*
							conteggioEsercizi = parseInt(conteggioEsercizi)+1;
															
								if(conteggioEsercizi == totaleEsercizi) {
								alert("scaricati "+conteggioEsercizi+" esercizi");
								sessionStorage.setItem("downloadEsercizi", "ok");
								}
							*/
						},
						function(error) {
							console.log("download error source " + error.source);
							console.log("download error target " + error.target);
						},
						false,
						{
							headers: {
								"Authorization": "Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="
							}
						}
				
					); // end of fileTransfer.download
				}); // end of dirEntry.getFile
			
			}); // fileSystem.root.getDirectory
			
		}); // end of window.requestFileSystem
		
	} //FUNCTION downloadJSON
	
	//DOWNLOAD JSONmulti FUNCTION
	function downloadJSONmulti(directory, fileName, fileURL) {
		
		var fileTransfer = new FileTransfer();
		
		window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSystem) {
			
			fileSystem.root.getDirectory(directory, {create: true, exclusive: false}, function(dirEntry) {
			
				dirEntry.getFile(fileName, {create: true, exclusive: false}, function(fileEntry) {
										
					var localPath = fileEntry.fullPath;

					if (device.platform === "Android" && localPath.indexOf("file://") === 0) {
							localPath = localPath.substring(7);
					}
					
					fileTransfer.download(
						fileURL,
						localPath,
						function(entry) {
						
						var numElementi = window.sessionStorage.getItem("numElementi");
						numElementi = parseInt(numElementi)-1;
													
								if(numElementi == 0) {
							
									if(sessionStorage.getItem("vetrineOK") == 0) {
									$("li.sottocategorie").html("download sottocategorie <img src='img/downloadok.png'>");
									$("li.sottocategorie").css("color","green");
									getVetrine();
									}
									else if(sessionStorage.getItem("vetrineOK") == 1) {
									$("li.vetrine").html("download vetrine <img src='img/downloadok.png'>");
									$("li.vetrine").css("color","green");
									
									$("p.downloadComplete").html("<a href='opzioni.html' class='ui-btn' data-transition='slide'>Fatto</a>");
									}
								}
								else {
								sessionStorage.setItem("numElementi", numElementi);
								}
						},
						function(error) {
							alert("download error source " + error.source);
							alert("download error target " + error.target);
						},
						false,
						{
							headers: {
								"Authorization": "Basic dGVzdHVzZXJuYW1lOnRlc3RwYXNzd29yZA=="
							}
						}
				
					); // end of fileTransfer.download
				}); // end of dirEntry.getFile
			
			}); // fileSystem.root.getDirectory
			
		}); // end of window.requestFileSystem
		
	} //FUNCTION downloadJSONmulti
	
	function getVetrine() {
	sessionStorage.setItem("vetrineOK", 1);

	$.ajax({
		url: "http://www.wificomo.com/ccn20/JSONidEsercizi.php",
		dataType: 'json',
		success: function(data) {
		
		var totaleEsercizi = data.length;
		window.sessionStorage.setItem("numElementi", totaleEsercizi);
		
			$.each(data, function(index, info) {
		
			var urlEsercizi = encodeURI("http://www.wificomo.com/ccn20/JSONvetrinaEsercizio.php?language="+codLingua+"&idEsercizio="+info.idEsercizio+"");	
			var fileNameEsercizi = info.idEsercizio+".js";	
			var directoryEsercizi = "ccn/esercizi";
		
			downloadJSONmulti(directoryEsercizi, fileNameEsercizi, urlEsercizi);
			});
		
		}
	});
	
	}
		</script>
		
		<ul style="list-style-type: none">
	<li class="categorie">download categorie...<img src="img/download.gif"></li>
	<li class="sottocategorie">download sottocategorie...<img src="img/download.gif"></li>
	<li class="nome">configurazione ricerca per nome... <img src="img/download.gif"></li>
	<li class="brandEsercizi">configurazione brand... <img src="img/download.gif"></li>
	<li class="brand">download brand... <img src="img/download.gif"></li>
	<li class="position">download posizioni esercizi... <img src="img/download.gif"></li>
	<li class="distance">configurazione distanze... <img src="img/download.gif"></li>
	<li class="vetrine">download vetrine...<img src="img/download.gif"></li>
	</ul>
	
	<p class="downloadComplete">attendere...</p>
	
		</div>
		<!-- /CONTENT -->

		<!-- FOOTER -->
		<div data-role="footer" data-theme="a" data-position="fixed"><h4>Page Footer</h4></div>
		<!-- /FOOTER -->
		
		</div>
<!-- /PAGE #downloadLingua -->

<!-- PAGE #opzioni -->
		<div data-role="page" id="opzioni">

		<!-- /HEADER -->
		<div data-role="header"><h1>Opzioni</h1></div>
		<!-- /HEADER -->
	
		<!-- CONTENT -->
		<div role="main" class="ui-content" >
	
		</div>
		<!-- /CONTENT -->

		<!-- FOOTER -->
		<div data-role="footer" data-theme="a" data-position="fixed"><h4>Page Footer</h4></div>
		<!-- /FOOTER -->
		
		</div>
<!-- /PAGE #opzioni -->

</body>
</html>