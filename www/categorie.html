<!DOCTYPE html>
<html>
<head>
	<title>Page Title</title>

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="stylesheet" href="css/themes/shopincomo.min.css" />
	<link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
	<link rel="stylesheet" href="css/jquery.mobile.structure-1.4.2.min.css" />
	
	<link rel="stylesheet" href="css/template.css" />
	
	<script src="js/jquery-1.11.0.min.js"></script>
	<script src="js/jquery.mobile-1.4.1.min.js"></script>
	<script type="text/javascript" src="cordova.js"></script>
</head>
<body>

<!-- Start of page: #categorie -->
	<div data-role="page" id="categorie">

	<!-- /HEADER -->
	<div data-role="header">
	<h1 id="titolo">Categorie</h1>
	<a href="index.html" rel="external" class="ui-btn ui-shadow ui-corner-all ui-icon-home ui-btn-icon-notext ui-alt-icon ui-nodisc-icon" data-transition="slide" data-direction="reverse">indietro</a>
	</div>
	<!-- /HEADER -->

	<div role="main" class="ui-content" >
	
	<script type="text/javascript" charset="utf-8">
	$( "#categorie" ).on( "pagebeforeshow", function() {
	
	document.addEventListener("backbutton", function(e){
    
		navigator.app.backHistory()
		
	}, false);
	
	// T.HEADER
	//var indietro = window.localStorage.getItem("indietro");
	//$("a#indietro").text(indietro);
	
	// T.H1
	//var titolo = window.localStorage.getItem("Categorie");
	//$("h1#titolo").text(titolo);
	
	//CARICA JSON CATEGORIE
	var path = window.localStorage.getItem("pathSD");
	var jsonPath = path + "/categorie.js";
	
	//LISTA CATEGORIE
	$("ul#listaCategorie").html("");
	
	$.getJSON(jsonPath, function( data ) {
		$.each(data, function(index, info) {
		$("ul#listaCategorie").append($("<li></li>",{"html":"<a href='#esercizi' class='categoria' id='" + info.idCategoria + "' jsonName='"+info.jsonName+"' data-transition='slide' >" +info.nomeCategoria+ "</a>" }));
		});
	
	$("ul#listaCategorie").listview("refresh");
	});
	
	}); //ON "pagebeforeshow"
	
	$(document).on("click", 'a.categoria', function(){
		idCategoria = $(this).attr('id');
		jsonName = $(this).attr('jsonName');
	});
		
	</script>
		
	<ul id="listaCategorie" data-role="listview">
	</ul>
		
	</div><!-- /content -->

	<div data-role="footer" data-theme="a" data-position="fixed">
		<h4>Page Footer</h4>
	</div><!-- /footer -->
	</div>
<!-- /page categorie -->

<!-- Start of page: #esercizi -->
	<div data-role="page" id="esercizi">

	<!-- /HEADER -->
	<div data-role="header">
	<h1>Title</h1>
	<a href="#categorie" class="ui-btn ui-shadow ui-corner-all ui-icon-carat-l ui-btn-icon-notext ui-alt-icon ui-nodisc-icon" data-transition="slide" data-direction="reverse">indietro</a>
	</div>
	<!-- /HEADER -->

	<div role="main" class="ui-content" >
	
	<script type="text/javascript" charset="utf-8">

	$( "#esercizi" ).on( "pagebeforeshow", function() {
	
	var maxLista = 2;
	var startIn = 2;
	sessionStorage.setItem("start", startIn);
	
	$("ul#lista_esercizi").html("");
	
	$("button#bottone").show();
	
	//CARICA JSON CATEGORIE
	var path = window.localStorage.getItem("pathSD");
	var jsonPath = path + "/"+jsonName+".js";
	
	// T.HEADER
	var indietro = window.localStorage.getItem("indietro");
	$("a#indietro").text(indietro);
	
	// T.NAVBAR
	var filtra = window.localStorage.getItem("filtra");
	$("a#filtro").text(filtra);
	
	var ordina = window.localStorage.getItem("ordina");
	$("a#ordinamento").text(ordina);
	
	// T.H1
	var titolo = window.localStorage.getItem("Categorie");
	$("h1#titolo").text(titolo);
	
	// T.H1
	var titolo = window.localStorage.getItem("Categorie");
	$("h1#titolo").text(titolo);
	
	var jsonSottocategorie;
	
	$.ajax({
	url: jsonPath,
	dataType: 'json',
	async: false,
		success: function(data) {
		jsonSottocategorie = data;
		}
	});
	
	jsonSottocategorie = jsonSottocategorie.sort(function (a, b) {
			a = a.nomeEsercizio
			b = b.nomeEsercizio;
			return a.localeCompare(b);
	});
	
	//LISTA ESERCIZI
	$.each(jsonSottocategorie, function(index, info) {
		if(index < maxLista) {
		$("ul#lista_esercizi").append($("<li></li>",{"html":"<a href='#vetrinaEsercizio' class='esercizio' id='" + info.IdEsercizio + "' data-transition='slide' >" + info.nomeEsercizio + "</a>" }));
		}
	});
	$("ul#lista_esercizi").listview("refresh");
	
	sessionStorage.setItem('currentJSON', JSON.stringify(jsonSottocategorie));
	
	//INPUT FILTRO
	var fieldsetFiltro = $('fieldset#fieldsetFiltro');
	
	fieldsetFiltro.controlgroup("container").html("");
	fieldsetFiltro.controlgroup("container").append('<input type="radio" class="filtro" name="filtro" id="all" value="all" checked="checked"><label for="all">Tutti</label>');
	
	var sottocategorie = [];
	
	var L = jsonSottocategorie.length;
	
	for (var i = 0; i < L; i++) {
		
		var obj = jsonSottocategorie[i];
    
			for (var j in obj) {
			var id = obj[j];
				
				if(j != "idEsercizio" && j != "nomeEsercizio" && j != "Punteggio") {
		
					if ($.inArray(j, sottocategorie) == -1) {
					sottocategorie.push(j);
					
					countNegoziSottocategoria = jQuery.grep(jsonSottocategorie, function(element, index){
					return element[j] != null;
					});
					
					countNegozi = countNegoziSottocategoria.length;
					
		$('#fieldsetFiltro')
        .controlgroup("container")
        .append('<input type="radio" name="filtro" class="filtro" id="' + id + '" value="'+j+'" /><label for="'+id+'">'+j+' ('+countNegozi+')</label>');
					}
				}
			}
	}
		
	$("#fieldsetFiltro")
    .enhanceWithin()
    .controlgroup("refresh");
	
	//CAMBIO FILTRO
	$( "input.filtro" ).change(function() {
	filtro = $(this).val();
    var idCategoria = $(this).attr('id');
	
	console.log("filtro:" + filtro);
	console.log("sottocategoria:" + idCategoria);
	
	window.sessionStorage.setItem('start', 2);
	$("button#bottone").show();
	
	window.sessionStorage.setItem('filtro', filtro);
	window.sessionStorage.setItem('sottocategoria', idCategoria);
	
	var existSottocategoria = [];
	
	if(idCategoria != 'all') {
		jsonFiltro = $.grep(jsonSottocategorie, function(v) {
		if ($.inArray(v.nomeEsercizio, existSottocategoria) !== -1) {
			return false;
		}
		else {
			existSottocategoria.push(v.nomeEsercizio);
			return v[filtro] == idCategoria;
		}
		});
	}
	else if(idCategoria == 'all') {
	jsonFiltro = jsonSottocategorie;
	}
	
	if(startIn >= jsonFiltro.length) {
	$("button#bottone").hide();
	}
	
	
	//RIORDINA SE SELEZIONATO UN ORDINAMENTO
	ordinamento = window.sessionStorage.getItem("ordinamento");
	if(ordinamento != null) {
	console.log("riordinamento");
	console.log("ordinamento: " + ordinamento);
		switch (ordinamento)
		{
		case "nome":
			jsonOrdinamento = jsonFiltro.sort(function (a, b) {
				a = a.nomeEsercizio
				b = b.nomeEsercizio;
				return a.localeCompare(b);
			});
			break;
		case "votoPopular":
			jsonOrdinamento = jsonFiltro.sort(function(a,b) { return parseFloat(b.Punteggio.votoPopular) - parseFloat(a.Punteggio.votoPopular) } );
			break;
		case "votoTrendy":
			jsonOrdinamento = jsonFiltro.sort(function(a,b) { return parseFloat(b.Punteggio.votoTrendy) - parseFloat(a.Punteggio.votoTrendy) } );
			break;
		}
	
		$("ul#lista_esercizi").html("");
		$.each(jsonOrdinamento, function(index, info) {
			if(index < maxLista) {
			$("ul#lista_esercizi").append($("<li></li>",{"html":"<a href='#vetrinaEsercizio' class='esercizio' id='" + info.IdEsercizio + "' data-transition='slide' >" + info.nomeEsercizio + "" }));
			}
		});
		$("ul#lista_esercizi").listview("refresh");
		sessionStorage.setItem('currentJSON', JSON.stringify(jsonOrdinamento));
		}
		else {
		$("ul#lista_esercizi").html("");
		$.each(jsonFiltro, function(index, info) {
			if(index < maxLista) {
			$("ul#lista_esercizi").append($("<li></li>",{"html":"<a href='#vetrinaEsercizio' class='esercizio' id='" + info.IdEsercizio + "' data-transition='slide' >" + info.nomeEsercizio + "" }));
			}
		});
		$("ul#lista_esercizi").listview("refresh");
		sessionStorage.setItem('currentJSON', JSON.stringify(jsonFiltro));
		}
	
	$('#popupFiltro').popup('close');
	
	});
	
	//CAMBIO ORDINAMENTO
	$( "input.ordinamento" ).change(function() {
	
	ordinamento = $(this).val();
	
	console.log("ordinamento:" + ordinamento)
	
	window.sessionStorage.setItem('start', 2);
	$("button#bottone").show();
	
	window.sessionStorage.setItem("ordinamento", ordinamento);
	
	switch (ordinamento)
	{
	case "nome":
		jsonOrdinamento = jsonSottocategorie.sort(function (a, b) {
			a = a.nomeEsercizio
			b = b.nomeEsercizio;
			return a.localeCompare(b);
		});
	break;
	case "votoPopular":
	jsonOrdinamento = jsonSottocategorie.sort(function(a,b) { return parseFloat(b.Punteggio.votoPopular) - parseFloat(a.Punteggio.votoPopular) } );
	break;
	case "votoTrendy":
	jsonOrdinamento = jsonSottocategorie.sort(function(a,b) { return parseFloat(b.Punteggio.votoTrendy) - parseFloat(a.Punteggio.votoTrendy) } );
	break;
	}
	
	//RIFILTRA SE SELEZIONATO UN FILTRO
	filtro = window.sessionStorage.getItem("filtro");
	
	if(filtro != null) {
	
	console.log("sto rifiltrando");
	console.log("filtro: " + filtro);
	
	idCategoria = window.sessionStorage.getItem("sottocategoria");
	
	console.log("sottocategoria: " + idCategoria);
		
		if(idCategoria != 'all') {
		var existSottocategoria = [];
		jsonFiltro = $.grep(jsonOrdinamento, function(v) {
			if ($.inArray(v.nomeEsercizio, existSottocategoria) !== -1) {
			return false;
			}
			else {
			existSottocategoria.push(v.nomeEsercizio);
			return v[filtro] == idCategoria;
			}
		});
		}
		else if(idCategoria == 'all') {
		jsonFiltro = jsonOrdinamento;
		}	
		
		$("ul#lista_esercizi").html("");
		$.each(jsonFiltro, function(index, info) {
			if(index < maxLista) {
			$("ul#lista_esercizi").append($("<li></li>",{"html":"<a href='#vetrinaEsercizio' class='esercizio' id='" + info.IdEsercizio + "' data-transition='slide' >" + info.nomeEsercizio + "" }));
			}
		});
		$("ul#lista_esercizi").listview("refresh");
		sessionStorage.setItem('currentJSON', JSON.stringify(jsonFiltro));
	}
	else{
	$("ul#lista_esercizi").html("");
	$.each(jsonOrdinamento, function(index, info) {
		if(index < maxLista) {
		$("ul#lista_esercizi").append($("<li></li>",{"html":"<a href='#vetrinaEsercizio' class='esercizio' id='" + info.IdEsercizio + "' data-transition='slide' >" + info.nomeEsercizio + "" }));
		}
	});
	$("ul#lista_esercizi").listview("refresh");
	sessionStorage.setItem('currentJSON', JSON.stringify(jsonOrdinamento));
	}
	
	$('#popupNested').popup('close');
	});
	
	}); //ON "pagebeforeshow"
	
	
	//SHOW MORE	
	$(document).on("click", 'button#bottone', function(){
	
	var start = sessionStorage.getItem("start");
	var end = parseInt(start)+2;	
	
	currentJSON = sessionStorage.getItem('currentJSON');
	
	var stop = JSON.parse(currentJSON).length;
		
	$.each(JSON.parse(currentJSON), function(index, info) {
	
		if(index >= start && index < end) {
		$("ul#lista_esercizi").append($("<li></li>",{"html":"<a href='#vetrinaEsercizio' class='esercizio' id='" + info.IdEsercizio + "' data-transition='slide' >" + info.nomeEsercizio + "" }));
		}
	});
	
	$("ul#lista_esercizi").listview("refresh");
	
	if(end >= stop) {
	$("button#bottone").hide();
	end = 2;
	}
	
	start = end;
	sessionStorage.setItem("start", start);
		
	});
	
	</script>
	
	<ul id="lista_esercizi" data-role="listview">
	</ul>
	
	<!-- POPUP ORDINAMENTO -->
	<div data-role="popup" id="popupNested" data-theme="none">
		<!-- ORDINAMENTO -->
		<form id="formOrdinamento">
		<fieldset id="fieldsetOrdinamento" data-role="controlgroup" data-type="vertical">
		<input type="radio" class="ordinamento" name="ordinamento" id="nome" value="nome" checked="checked"><label for="nome">Nome</label> 
		<input type="radio" class="ordinamento" name="ordinamento" id="votoPopular" value="votoPopular"><label for="votoPopular">Popular</label> 
		<input type="radio" class="ordinamento" name="ordinamento" id="votoTrendy" value="votoTrendy"><label for="votoTrendy">Trendy</label>
		</fieldset>
		</form>
		<!-- /ORDINAMENTO -->
	</div>
	<!-- /POPUP ORDINAMENTO-->
	
	</div><!-- /content -->

	<!-- FOOTER -->
	<div data-role="footer" data-theme="a" data-position="fixed">
	<button id="bottone" class="ui-btn">+2</button>
	<!-- NAVBAR -->
		<div data-role="navbar">
			<ul>
			<li><a id="filtro" href="#popupFiltro" data-rel="popup" data-transition="flip" data-icon="gear">Filtra</a></li>
			<li><a href="#popupNested" id="ordinamento" data-rel="popup" data-transition="flip" data-icon="gear">Ordina</a></li>
		</ul>
		</div>
	<!-- /NAVBAR -->
	</div>
	<!-- /FOOTER -->
	
	<!-- POPUP FILTRO-->
	<div data-role="popup" id="popupFiltro" data-theme="none">
		<!-- FILTRO -->
		<form id="formFiltro">
		<fieldset id="fieldsetFiltro" data-role="controlgroup" data-type="vertical">
		</fieldset>
		</form>
		<!-- /FILTRO -->
	</div>
	<!-- /POPUP FILTRO -->

</div><!-- /PAGE #listaEsercizi -->

</body>
</html>